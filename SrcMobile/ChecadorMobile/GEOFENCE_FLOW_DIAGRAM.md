# Diagrama de Flujo: Geofence con SQLite

## ?? Flujo de Login con Geofence

```
???????????????????????????????????????????????????????????????
?                      USUARIO INICIA SESIÓN                  ?
???????????????????????????????????????????????????????????????
                          ?
                          ?
                   ????????????????
                   ?  LoginAsync  ?
                   ????????????????
                          ?
                          ?
              ?????????????????????????
              ?  POST /api/auth/login ?
              ?  - Username           ?
              ?  - Password           ?
              ?????????????????????????
                          ?
                          ?
         ??????????????????????????????????
         ?      Backend Response          ?
         ?  ? Token                       ?
         ?  ? User Data                   ?
         ?  ? GeofenceConfig (NUEVO)      ?
         ?    - CenterLatitude            ?
         ?    - CenterLongitude           ?
         ?    - RadiusInMeters            ?
         ?    - LocationName              ?
         ??????????????????????????????????
                      ?
                      ?
         ??????????????????????????????????
         ?   AuthService.LoginAsync       ?
         ?   1. Guardar User en SQLite    ?
         ?   2. Guardar Geofence en       ?
         ?      SQLite (NUEVO)            ?
         ?   3. Actualizar LastLogin      ?
         ?   4. Guardar en Preferences    ?
         ??????????????????????????????????
                      ?
                      ?
              ?????????????????
              ? ? Usuario     ?
              ? Autenticado    ?
              ? con Geofence   ?
              ?????????????????
```

## ?? Flujo de Registro de Asistencia

```
???????????????????????????????????????????????????????????????
?               USUARIO REGISTRA ASISTENCIA                   ?
???????????????????????????????????????????????????????????????
                          ?
                          ?
                ???????????????????????
                ? Verificar Permisos  ?
                ? de Ubicación        ?
                ???????????????????????
                          ? ?
                          ?
                ???????????????????????
                ? Obtener Ubicación   ?
                ? GPS Actual          ?
                ? - Latitude          ?
                ? - Longitude         ?
                ???????????????????????
                          ?
                          ?
        ???????????????????????????????????????
        ?  GetGeofenceConfigAsync()           ?
        ?  (CONSULTA DESDE SQLite - NO API)   ?
        ???????????????????????????????????????
                  ?
                  ?
     ??????????????????????????????
     ?  Geofence en SQLite?       ?
     ???????????????????????????????
          ? NO            ? SI
          ?               ?
  ?????????????????  ????????????????????????
  ? ? Error       ?  ? GeofenceHelper       ?
  ? "Intenta      ?  ? .IsWithinGeofence()  ?
  ? cerrar sesión"?  ? - Calcular distancia ?
  ?????????????????  ????????????????????????
                            ?
                            ?
               ??????????????????????????
               ? ¿Dentro del radio?     ?
               ??????????????????????????
                    ? NO        ? SI
                    ?           ?
         ????????????????????  ???????????????????????
         ? ? Mostrar Error  ?  ? ? Enviar a API      ?
         ? "Fuera del área" ?  ? POST /api/attendance?
         ? Distancia: XXXm  ?  ? /register           ?
         ????????????????????  ???????????????????????
                                         ?
                                         ?
                              ????????????????????????
                              ? ? Asistencia        ?
                              ? Registrada           ?
                              ????????????????????????
```

## ??? Estructura de Base de Datos SQLite

```
???????????????????????????????????????????
?         mauiapp.db3                     ?
???????????????????????????????????????????
?                                         ?
?  Tabla: User                            ?
?  ?? Id (PK)                             ?
?  ?? Username                            ?
?  ?? Password                            ?
?  ?? FullName                            ?
?  ?? Email                               ?
?  ?? CreatedAt                           ?
?  ?? LastLogin                           ?
?  ?? IsActive                            ?
?                                         ?
?  Tabla: GeofenceConfig (NUEVA)          ?
?  ?? Id (PK, AutoIncrement)              ?
?  ?? UserId (FK ? User.Id)               ?
?  ?? CenterLatitude                      ?
?  ?? CenterLongitude                     ?
?  ?? RadiusInMeters                      ?
?  ?? LocationName                        ?
?  ?? UpdatedAt                           ?
?                                         ?
???????????????????????????????????????????
```

## ?? Comparación: Antes vs Ahora

### ? Implementación ANTERIOR (menos eficiente)
```
Login ? Guardar User
Registrar Asistencia:
  1. Obtener GPS
  2. Llamar API: GET /api/geofence/{userId}  ?? Llamada extra
  3. Validar geofence
  4. Llamar API: POST /api/attendance/register
```

### ? Implementación ACTUAL (optimizada)
```
Login ? Guardar User + Guardar Geofence
Registrar Asistencia:
  1. Obtener GPS
  2. Leer geofence de SQLite  ? Sin llamada a API
  3. Validar geofence
  4. Llamar API: POST /api/attendance/register
```

## ?? Beneficios

| Aspecto | Anterior | Actual |
|---------|----------|--------|
| Llamadas API por registro | 2 | 1 |
| Funciona offline | ? No | ? Si |
| Tiempo de respuesta | Lento | Rápido |
| Sincronización | Manual | Automática (al login) |
| Complejidad backend | 2 endpoints | 1 endpoint |
